<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dam Locations</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
</head>
<body>

<form id="filterForm">
    <label for="waterquality">Water Quality:</label>
    <select id="waterquality" name="waterquality">
        <option value="default">Select</option>
        <option value="Good">Good</option>
        <option value="Moderate">Moderate</option>
        <option value="Poor">Poor</option>
    </select>

    <label for="city">City:</label>
    <input type="text" id="city" name="city"/>

    <label for="waterLevel">Water Level:</label>
    <select id="waterLevel" name="waterLevel">
        <option value="default">Select</option>
        <option value="High">High</option>
        <option value="Medium">Medium</option>
        <option value="Low">Low</option>
    </select>

    <label for="capacity">Capacity:</label>
    <input type="number" id="capacity" name="capacity"/>

    <label for="operationalStatus">Operational Status:</label>
    <select id="operationalStatus" name="operationalStatus">
        <option value="default">Select</option>
        <option value="Operational">Operational</option>
        <option value="Under Maintenance">Under Maintenance</option>
    </select>

    <button type="submit">Apply Filters</button>
    <button type="button" id="resetBtn">Reset Filters</button> <!-- Reset button -->
</form>

<!-- Map -->
<div id="map" style="height: 600px;"></div>

<script>
// Initialize the map
var map = L.map('map').setView([36.8171, 9.1833], 7); // Default to Tunisia

// Set up the tile layer
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map);

// Function to fetch and plot dam locations
function fetchAndPlotData(filters) {
    fetch('fetch_dams.php', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(filters)
    })
    .then(response => response.json())
    .then(data => {
        // Clear existing markers
        map.eachLayer(function(layer) {
            if (layer instanceof L.Marker) {
                map.removeLayer(layer);
            }
        });

        // Plot the dam locations
        data.forEach(function(dam) {
            var lat = parseFloat(dam.Latitude);
            var lng = parseFloat(dam.Longitude);
            var marker = L.marker([lat, lng]).addTo(map);
            marker.bindPopup(`<b>${dam.Dam}</b><br>City: ${dam.city}<br>Water Quality: ${dam.waterquality}`);
        });
    })
    .catch(error => console.error('Error fetching dam data:', error));
}

// Function to get filter values and exclude default ones
function getFilters() {
    var filters = {};

    // Check each filter and only add it if the value is not default
    var waterquality = document.getElementById('waterquality').value;
    if (waterquality !== 'default') filters.waterquality = waterquality;

    var city = document.getElementById('city').value;
    if (city) filters.city = city;

    var waterLevel = document.getElementById('waterLevel').value;
    if (waterLevel !== 'default') filters.waterLevel = waterLevel;

    var capacity = document.getElementById('capacity').value;
    if (capacity) filters.capacity = capacity;

    var operationalStatus = document.getElementById('operationalStatus').value;
    if (operationalStatus !== 'default') filters.operationalStatus = operationalStatus;

    return filters;
}

// Fetch data when filters are applied
document.getElementById('filterForm').addEventListener('submit', function(e) {
    e.preventDefault();

    var filters = getFilters();
    fetchAndPlotData(filters);
});

// Reset filters when reset button is clicked
document.getElementById('resetBtn').addEventListener('click', function() {
    // Reset form fields
    document.getElementById('filterForm').reset();
    
    // Fetch all data without filters
    fetchAndPlotData({});
});

// Load initial data (optional)
fetchAndPlotData({});
</script>

</body>
</html>

    </script>
</body>
</html>
