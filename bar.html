<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dam Locations</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
</head>
<body>

<form id="filterForm">
    <label for="waterquality">Water Quality:</label>
    <select id="waterquality" name="waterquality">
        <option value="default">Select</option>
        <option value="Good">Good</option>
        <option value="Moderate">Moderate</option>
        <option value="Poor">Poor</option>
    </select>

    <label for="city">City:</label>
    <select id="city" name="city">
        <option value="default">Select</option>
        <option value="Bizerte">Bizerte</option>
        <option value="Kef">Kef</option>
        <option value="Beja">Beja</option>
    </select>

    <label for="waterLevel">Water Level:</label>
    <select id="waterLevel" name="waterLevel">
        <option value="default">Select</option>
        <option value="High">High</option>
        <option value="Medium">Medium</option>
        <option value="Low">Low</option>
    </select>

    <label for="capacity">Capacity:</label>
    <input type="number" id="capacity" name="capacity"/>

    <label for="operationalStatus">Operational Status:</label>
    <select id="operationalStatus" name="operationalStatus">
        <option value="default">Select</option>
        <option value="Operational">Operational</option>
        <option value="Under Maintenance">Under Maintenance</option>
    </select>

    <button type="submit">Apply Filters</button>
    <button type="button" id="resetBtn">Reset Filters</button> 
</form>


<div id="map" style="height: 600px;"></div>

<script>
// Initialize the map
var map = L.map('map').setView([36.8171, 9.1833], 7); // Default to Tunisia


L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map);


function fetchAndPlotData(filters, asMarkers = false) {
    fetch('fetch_dams.php', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(filters)
    })
    .then(response => response.json())
    .then(data => {
        
        map.eachLayer(function(layer) {
            if (layer instanceof L.Marker || layer instanceof L.CircleMarker) {
                map.removeLayer(layer);
            }
        });

        
        data.forEach(function(dam) {
            var lat = parseFloat(dam.Latitude);
            var lng = parseFloat(dam.Longitude);
            if (asMarkers) {
               
                var marker = L.marker([lat, lng]).addTo(map);
                marker.bindPopup(`<b>${dam.Dam}</b><br>City: ${dam.city}<br>Water Quality: ${dam.waterquality}`);
            } else {
                
                var point = L.circleMarker([lat, lng], {
                    radius: 5, 
                    color: 'blue', 
                    fillColor: 'blue',
                    fillOpacity: 0.8
                }).addTo(map);
                point.bindPopup(`<b>${dam.Dam}</b><br>City: ${dam.city}<br>Water Quality: ${dam.waterquality}`);
            }
        });
    })
    .catch(error => console.error('Error fetching dam data:', error));
}


function getFilters() {
    var filters = {};

    
    var waterquality = document.getElementById('waterquality').value;
    if (waterquality !== 'default') filters.waterquality = waterquality;

    var city = document.getElementById('city').value;
    if (city) filters.city = city;

    var waterLevel = document.getElementById('waterLevel').value;
    if (waterLevel !== 'default') filters.waterLevel = waterLevel;

    var capacity = document.getElementById('capacity').value;
    if (capacity) filters.capacity = capacity;

    var operationalStatus = document.getElementById('operationalStatus').value;
    if (operationalStatus !== 'default') filters.operationalStatus = operationalStatus;

    return filters;
}


document.getElementById('filterForm').addEventListener('submit', function(e) {
    e.preventDefault();

    var filters = getFilters();
    fetchAndPlotData(filters, true); 
});


document.getElementById('resetBtn').addEventListener('click', function() {
    
    document.getElementById('filterForm').reset();

   
    fetchAndPlotData({}, false);
});


fetchAndPlotData({}, false);

fetch('./monastir.geojson') 
    .then((response) => response.json())
    .then((data) => {
       
        L.geoJSON(data, {
            style: function () {
                return {
                    color: "transparent" ,
                    fillOpacity: 0.1 
                };
            },
            onEachFeature: function (feature, layer) {
                layer.on('click', function () {
                   
                    map.eachLayer((layer) => {
                        if (layer instanceof L.GeoJSON) {
                            layer.setStyle({
                                color: "transparent",
                                fillOpacity: 0.1
                            });
                        }
                    });

                    
                    layer.setStyle({
                        color: "red", 
                        fillOpacity: 0.5 
                    });

                    
                    map.fitBounds(layer.getBounds());
                });
            }
        }).addTo(map);
    })
    .catch((error) => console.error('Error loading GeoJSON data:', error));


fetchAndPlotData({});
</script>

</body>
</html>
